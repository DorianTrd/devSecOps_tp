name: CI/CD Pipeline

on:
  pull_request:
    branches:
      - develop
      - main

jobs:
  docker-build-and-push:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Construire les images Docker
      - name: Build Backend Image
        run: docker build -t backend-ci ./backend
        
      - name: Build Frontend Image
        run: docker build -t frontend-ci ./frontend

      # 2. Healthcheck simple
      - name: Simple Backend Healthcheck
        run: |
          docker run -d -p 3000:3000 --name backend-test backend-ci
          sleep 5
          docker exec backend-test sh -c "apk add curl; curl -s -f http://localhost:3000 || exit 1"
          docker rm -f backend-test
          
      - name: Simple Frontend Healthcheck
        run: |
          docker run -d -p 8080:80 --name frontend-test frontend-ci
          sleep 5
          docker exec frontend-test sh -c "apk add curl; curl -s -f http://localhost:80 || exit 1"
          docker rm -f frontend-test

      # 3. Login GHCR
      - name: Log in to GitHub Container Registry (GHCR)
        run: echo ${{ secrets.GHCR_PAT }} | docker login ghcr.io -u DorianTrd --password-stdin

      # 4. Tag et Push
      - name: Tag and Push Backend Image
        run: |
          docker tag backend-ci ghcr.io/DorianTrd/cloudnative-backend:${{ github.sha }}
          docker tag backend-ci ghcr.io/DorianTrd/cloudnative-backend:latest
          docker push ghcr.io/DorianTrd/cloudnative-backend:${{ github.sha }}
          docker push ghcr.io/DorianTrd/cloudnative-backend:latest
          
      - name: Tag and Push Frontend Image
        run: |
          docker tag frontend-ci ghcr.io/DorianTrd/cloudnative-frontend:${{ github.sha }}
          docker tag frontend-ci ghcr.io/DorianTrd/cloudnative-frontend:latest
          docker push ghcr.io/DorianTrd/cloudnative-frontend:${{ github.sha }}
          docker push ghcr.io/DorianTrd/cloudnative-frontend:latest
