name: CI Pipeline Docker

on:
  pull_request:
    branches:
      - develop
      - main

jobs:
  build-and-push-docker:
    runs-on: self-hosted
    steps:
      # 1Ô∏è‚É£ Checkout repository
      - uses: actions/checkout@v3

      # 2Ô∏è‚É£ Docker login GHCR
      - name: Docker login
        shell: pwsh
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u DorianTrd --password-stdin

      # 3Ô∏è‚É£ Build backend
      - name: Build backend Docker image
        shell: pwsh
        run: docker build -t backend-ci ./backend

      # 4Ô∏è‚É£ Build frontend
      - name: Build frontend Docker image
        shell: pwsh
        run: docker build -t frontend-ci ./frontend

      # 5Ô∏è‚É£ Tag & push backend
      - name: Tag & push backend
        shell: pwsh
        run: |
          docker tag backend-ci ghcr.io/DorianTrd/cloudnative-backend:${{ github.sha }}
          docker push ghcr.io/DorianTrd/cloudnative-backend:${{ github.sha }}

      # 6Ô∏è‚É£ Tag & push frontend
      - name: Tag & push frontend
        shell: pwsh
        run: |
          docker tag frontend-ci ghcr.io/DorianTrd/cloudnative-frontend:${{ github.sha }}
          docker push ghcr.io/DorianTrd/cloudnative-frontend:${{ github.sha }}

      # 7Ô∏è‚É£ Stop old containers
      - name: Stop existing containers
        shell: pwsh
        run: |
          docker rm -f backend-test -ErrorAction SilentlyContinue
          docker rm -f frontend-test -ErrorAction SilentlyContinue

      # 8Ô∏è‚É£ Run containers for healthcheck
      - name: Run containers
        shell: pwsh
        run: |
          docker run -d --name backend-test -p 3000:3000 backend-ci
          docker run -d --name frontend-test -p 8080:80 frontend-ci
          docker ps

      # 9Ô∏è‚É£ Check backend health
      - name: Check backend health
        shell: pwsh
        run: |
          try {
              Invoke-WebRequest -UseBasicParsing -Uri http://localhost:3000 -TimeoutSec 10
          } catch {
              Write-Error "Backend healthcheck failed"
              exit 1
          }

      # üîü Check frontend health
      - name: Check frontend health
        shell: pwsh
        run: |
          try {
              Invoke-WebRequest -UseBasicParsing -Uri http://localhost:8080 -TimeoutSec 10
          } catch {
              Write-Error "Frontend healthcheck failed"
              exit 1
          }
