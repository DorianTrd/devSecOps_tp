name: CI Docker

on:
  pull_request:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: self-hosted
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

    steps:
      # 1️⃣ Checkout du code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ Docker Hub Login
      - name: Docker Hub Login
        shell: powershell
        run: docker login -u $env:DOCKERHUB_USERNAME -p $env:DOCKERHUB_TOKEN

      # 3️⃣ Build Backend
      - name: Build backend image
        shell: powershell
        run: docker build -t backend-ci ./backend

      # 4️⃣ Build Frontend
      - name: Build frontend image
        shell: powershell
        run: docker build -t frontend-ci ./frontend

      # 5️⃣ Healthcheck Backend
      - name: Run backend container and test
        shell: powershell
        run: |
          # Supprimer l'ancien container si présent
          $existing = docker ps -a -q -f name=backend-test
          if ($existing) { docker rm -f backend-test }

          # Lancer le container
          docker run -d -p 3000:3000 --name backend-test backend-ci

          # Attendre le démarrage
          Start-Sleep -Seconds 10

          # Healthcheck sur /health (à créer dans NestJS)
          try {
              Invoke-WebRequest -Uri http://localhost:3000/health -UseBasicParsing -TimeoutSec 5
          } catch {
              Write-Error "Backend healthcheck failed"
              exit 1
          }

          # Supprimer le container après test
          docker rm -f backend-test

      # 6️⃣ Healthcheck Frontend
      - name: Run frontend container and test
        shell: powershell
        run: |
          $existing = docker ps -a -q -f name=frontend-test
          if ($existing) { docker rm -f frontend-test }

          docker run -d -p 8080:80 --name frontend-test frontend-ci
          Start-Sleep -Seconds 10

          try {
              Invoke-WebRequest -Uri http://localhost:8080/ -UseBasicParsing -TimeoutSec 5
          } catch {
              Write-Error "Frontend healthcheck failed"
              exit 1
          }

          docker rm -f frontend-test

      # 7️⃣ Tag + Push Backend
      - name: Tag & push backend image
        shell: powershell
        run: |
          docker tag backend-ci $env:DOCKERHUB_USERNAME/cloudnative-backend:${{ github.sha }}
          docker tag backend-ci $env:DOCKERHUB_USERNAME/cloudnative-backend:latest
          docker push $env:DOCKERHUB_USERNAME/cloudnative-backend:${{ github.sha }}
          docker push $env:DOCKERHUB_USERNAME/cloudnative-backend:latest

      # 8️⃣ Tag + Push Frontend
      - name: Tag & push frontend image
        shell: powershell
        run: |
          docker tag frontend-ci $env:DOCKERHUB_USERNAME/cloudnative-frontend:${{ github.sha }}
          docker tag frontend-ci $env:DOCKERHUB_USERNAME/cloudnative-frontend:latest
          docker push $env:DOCKERHUB_USERNAME/cloudnative-frontend:${{ github.sha }}
          docker push $env:DOCKERHUB_USERNAME/cloudnative-frontend:latest
